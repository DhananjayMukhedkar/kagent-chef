#!/usr/bin/env bash

function _help {
    echo "Helper script to rotate the zfs key"
    echo "Usage: zfs-rotate.sh passphrase"
}

set -e

if [ $# -ne 1 ]
then
    _help
    exit 2
fi

PASSPHRASE=$1
DATASETS=<%= node['zfs']['datasets'] %>


for i in $(echo $DATASETS | sed "s/,/ /g")
do
 name="$(basename -- $i)"
 /usr/bin/expect <<EOF
 EOF
    spawn zfs change-key -l -o keyformat=passphrase -o keylocation=prompt $name
    expect "Enter passphrase: \r"
    send "${PASSPHRASE}\r"
    expect "Re-enter passphrase: \r"
    send "${PASSPHRASE}\r"
 EOF
    
done

