#!/usr/bin/env bash


# Details on how to securely pass parameter from agent.py to this script:
# https://unix.stackexchange.com/questions/188536/how-to-make-a-temporary-file-in-ram

function _help {
    echo "Helper script to run zfs datasets create"
    echo "Usage: zfs-create.sh passphrase"
}

set -e

if [ $# -ne 1 ]
then
    _help
    exit 2
fi

KEY_FILE=/dev/shm/zfs.key
PASSPHRASE=$1
DATASETS=<%= node['zfs']['datasets'] %>
# datasets are in the format "file:///disks/hdfs/1,file:///disks/hdfs/2, ..."
DATADIRS=<%= @hopsfs_datadirs %>

IFS=',' read -ra DIRS <<< "$DATADIRS"

x=0
for i in $(echo $DATASETS | sed "s/,/ /g")
do	 
 zfs create -o encryption=aes-128-gcm -o keyformat=passphrase -o keylocation=file:///${KEY_FILE} -o mountpoint=$DIRS[$x] $i
 ((x++))   
done
