#!/usr/bin/env bash

function _help {
    echo "Helper script to run zfs datasets create"
    echo "Usage: zfs-create.sh passphrase"
}

set -e

if [ $# -ne 1 ]
then
    _help
    exit 2
fi

PASSPHRASE=$1
DATASETS=<%= node['zfs']['datasets'] %>
# datasets are in the format "file:///disks/hdfs/1,file:///disks/hdfs/2, ..."
DATADIRS=<%= @hopsfs_datadirs %>

IFS=',' read -ra DIRS <<< "$DATADIRS"

x=0
for i in $(echo $DATASETS | sed "s/,/ /g")
do	 
 /usr/bin/expect <<EOF
 EOF
    spawn zfs create -o encryption=aes-128-gcm -o keyformat=passphrase -o keylocation=prompt -o mountpoint=$DIRS[$x] $i
    expect "Enter passphrase: \r"
    send "${PASSPHRASE}\r"
    expect "Re-enter passphrase: \r"
    send "${PASSPHRASE}\r"
 EOF
 ((x++))   
done
